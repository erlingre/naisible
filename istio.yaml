- name: Generate certificates
  hosts: localhost
  tasks:
  - name: Ensure PKI directory exists
    file: state=directory path=target/istio/pki/
  
  - name: Ensure PKI directory exists
    file: state=directory path=target/istio/bin/
  
  - name: Ensure kubeconfig directory exists
    file: state=directory path=kube

  - name: Generate istio-ingress-csr.json
    template: src=templates/istio/istio-ingress-csr.json.j2 dest=target/istio/pki/istio-ingress-csr.json
  
  - name: Creating istio-ingress certificate
    shell: bin/cfssl gencert -ca=target/pki/ca.pem -ca-key=target/pki/ca-key.pem -config=target/pki/ca-config.json -profile=server target/istio/pki/istio-ingress-csr.json | bin/cfssljson -bare target/istio/pki/istio-ingress
    args:
      creates: target/istio/pki/istio-ingress.pem
   
  - name: Creating istio-sidecar-injector certificate
    shell: bin/cfssl gencert -ca=target/pki/ca.pem -ca-key=target/pki/ca-key.pem -config=target/pki/ca-config.json -profile=server files/istio/istio-sidecar-injector-csr.json | bin/cfssljson -bare target/istio/pki/istio-sidecar-injector
    args:
      creates: target/istio/pki/istio-sidecar-injector.pem

- name: Copy kubeconfig from master
  hosts: masters
  user: deployer
  become: yes
  tasks:
  - name: fetch cluster-admin from master
    fetch: src=/etc/kubernetes/kubeconfigs/cluster-admin.conf dest=target/istio/kubeconfig flat=yes

- name: Create kubernetes resources
  hosts: localhost
  vars:
    kubectl: target/istio/bin/kubectl --kubeconfig target/istio/kubeconfig
  tasks:
  - name: Download kubernetes node binaries
    environment: "{{ proxy_env }}"
    shell: curl -L --insecure https://dl.k8s.io/v{{ k8s_version }}/kubernetes-node-linux-amd64.tar.gz | \
           tar xzf - -C /tmp kubernetes/node/bin/kubectl && \
           mv /tmp/kubernetes/node/bin/kubectl target/istio/bin/kubectl-{{ k8s_version }}
    args:
      creates: target/istio/bin/kubectl-{{k8s_version}}
 
  - name: Symlink kubernetes node binaries
    file: src=kubectl-{{ k8s_version }} dest=target/istio/bin/kubectl state=link force=yes

  - name: Install istio
    shell: "{{ kubectl }} apply -f files/istio/istio.yaml"

  - name: Install istio-sidecar-configmap
    shell: "{{ kubectl }} apply -f files/istio/istio-sidecar-injector-configmap-release.yaml"

  - name: Adding istio-sidecar-injector certificate secret
    shell: "{{ kubectl }} create secret generic sidecar-injector-certs --from-file=key.pem=target/istio/pki/istio-sidecar-injector-key.pem --from-file=cert.pem=target/istio/pki/istio-sidecar-injector.pem --dry-run -o yaml | {{ kubectl }} -n istio-system apply -f -"

  - name: Reading and encoding CA certificate bundle from file
    shell: cat target/pki/ca.pem | base64 | tr -d '\n'
    register: ca_bundle

  - name: Patch istio-sidecar-injector deployment
    template: src=templates/istio/istio-sidecar-injector.yaml.j2 dest=target/istio/istio-sidecar-injector-with-ca-bundle.yaml

  - name: Install istio-sidecar-injector
    shell: "{{ kubectl }} apply -f target/istio/istio-sidecar-injector-with-ca-bundle.yaml"
 
  - name: Ensure egress directory exists
    file: state=directory path=target/istio/egress

  - name: Create egress yaml files
    shell: "cat templates/istio/egress-domains.yaml.j2 | sed -e 's|\\${domain}|{{ item }}|g' > target/istio/egress/{{ item }}-egress.yaml"
    with_items: "{{ egress_domains.split(',') }}"

  - name: Whitelist domains via Egress
    shell: "{{ kubectl }} apply -f target/istio/egress/ -R"
